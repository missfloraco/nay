import{q as D,r as o,j as e,s as P,e as w,l as S,t as $,g as A,v as F}from"./index-3tzHmsOf.js";import{A as E}from"./adminlayout-ZagtXe8m.js";import{I as V,C as q,D as z,A as H,T as M}from"./table-cells-0QReMnwe.js";import{a as R}from"./helpers-CPSgdYRA.js";import{S as U}from"./sidebar-left-SDr9qEmE.js";import{U as B}from"./user-BF6dZPLy.js";import{C as G}from"./chevron-right-BQpY62PU.js";import{D as J,C as K}from"./dollar-sign-Dof078Ys.js";import"./adslot-DgJhm0dE.js";import"./sun-BINGn8lG.js";import"./users-m4cUupYH.js";import"./sparkles-BZvr4uos.js";import"./database-BLedNJg5.js";import"./mail-wdynseuz.js";import"./log-out-DEKz7YE3.js";const O=({tenants:u,selectedTenantId:i,onSelectTenant:m,onSuccess:x})=>{const{showToast:c}=D(),[d,N]=o.useState(""),[g,y]=o.useState(!1),[_,h]=o.useState(!1),[r,l]=o.useState({amount:"",subscription_end_date:"",payment_method:"cash",notes:""}),n=u.find(t=>t.id===Number(i));o.useEffect(()=>{h(!!i)},[i]);const f=u.filter(t=>t.name.toLowerCase().includes(d.toLowerCase())||t.email.toLowerCase().includes(d.toLowerCase())),C=async t=>{var j,k;if(t.preventDefault(),!i)return;if(!r.subscription_end_date)return c("يرجى اختيار تاريخ انتهاء الاشتراك","error");const b={tenant_id:i,amount:r.amount||null,subscription_end_date:r.subscription_end_date,payment_method:r.payment_method,notes:r.notes};y(!0);try{await w.post("/admin/payments",b),c("تم تسجيل الدفعة بنجاح","success"),x(),l({amount:"",subscription_end_date:"",payment_method:"cash",notes:""})}catch(v){S.error(v),c(((k=(j=v.response)==null?void 0:j.data)==null?void 0:k.message)||"فشل تسجيل الدفعة","error")}finally{y(!1)}};return e.jsxs("div",{className:"flex flex-col h-full space-y-6",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h3",{className:"text-sm font-black text-gray-400 dark:text-gray-500 uppercase tracking-widest",children:"إدارة العمليات"}),e.jsx("p",{className:"text-xs text-gray-500 font-bold",children:"اختر المشترك لتسجيل دفعة أو تصفية السجل"})]}),_?e.jsxs("div",{className:"flex-1 flex flex-col space-y-5 animate-in slide-in-from-left duration-300",children:[e.jsx("div",{className:"p-4 rounded-2xl bg-primary/5 dark:bg-primary/10 border border-primary/10 relative overflow-hidden group",children:e.jsxs("div",{className:"relative z-10 flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-xl bg-primary text-white flex items-center justify-center font-black",children:n==null?void 0:n.name.charAt(0)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-xs font-black text-gray-900 dark:text-white",children:n==null?void 0:n.name}),e.jsx("p",{className:"text-[10px] text-gray-500 font-bold",children:n==null?void 0:n.email})]}),e.jsx("button",{onClick:()=>m(""),className:"p-1.5 hover:bg-primary/10 rounded-lg text-primary transition-colors",children:e.jsx(G,{className:"w-4 h-4"})})]})}),e.jsxs("form",{onSubmit:C,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"text-[10px] font-black text-gray-400 uppercase tracking-widest px-1",children:"المبلغ (ILS)"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"number",min:"0",step:"0.01",value:r.amount,onChange:t=>l({...r,amount:t.target.value}),className:"w-full px-3 py-2.5 rounded-xl border border-gray-100 dark:border-dark-700 bg-gray-50/50 dark:bg-dark-800 focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all font-bold text-xs text-left",placeholder:"0.00"}),e.jsx(J,{className:"absolute right-3 top-2.5 w-4 h-4 text-gray-400"})]})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"text-[10px] font-black text-gray-400 uppercase tracking-widest px-1",children:"انتهاء الاشتراك"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"date",value:r.subscription_end_date,onChange:t=>l({...r,subscription_end_date:t.target.value}),className:"w-full px-3 py-2.5 rounded-xl border border-gray-100 dark:border-dark-700 bg-gray-50/50 dark:bg-dark-800 focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all font-bold text-xs",required:!0}),e.jsx(K,{className:"absolute left-3 top-2.5 w-4 h-4 text-gray-400"})]})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"text-[10px] font-black text-gray-400 uppercase tracking-widest px-1",children:"طريقة الدفع"}),e.jsxs("select",{value:r.payment_method,onChange:t=>l({...r,payment_method:t.target.value}),className:"w-full px-3 py-2.5 rounded-xl border border-gray-100 dark:border-dark-700 bg-gray-50/50 dark:bg-dark-800 focus:ring-2 focus:ring-primary/20 transition-all font-bold text-xs",children:[e.jsx("option",{value:"cash",children:"نقد"}),e.jsx("option",{value:"bank_transfer",children:"تحويل بنكي"}),e.jsx("option",{value:"check",children:"شيك"})]})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("label",{className:"text-[10px] font-black text-gray-400 uppercase tracking-widest px-1",children:"ملاحظات"}),e.jsx("textarea",{value:r.notes,onChange:t=>l({...r,notes:t.target.value}),className:"w-full px-3 py-2.5 rounded-xl border border-gray-100 dark:border-dark-700 bg-gray-50/50 dark:bg-dark-800 focus:ring-2 focus:ring-primary/20 transition-all font-medium text-xs h-20 resize-none",placeholder:"..."})]}),e.jsx("button",{type:"submit",disabled:g,className:"w-full py-3 bg-primary hover:bg-primary-dark text-white rounded-xl text-xs font-black transition-all shadow-lg hover:shadow-primary/30 active:scale-95 disabled:opacity-50 flex items-center justify-center gap-2",children:g?e.jsx("div",{className:"w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(P,{className:"w-4 h-4"}),"حفظ البيانات"]})})]})]}):e.jsxs("div",{className:"flex-1 flex flex-col space-y-4 overflow-hidden",children:[e.jsxs("div",{className:"relative",children:[e.jsx(U,{className:"absolute right-3 top-2.5 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"بحث عن مشترك...",value:d,onChange:t=>N(t.target.value),className:"w-full pr-9 pl-3 py-2 rounded-xl border border-gray-100 dark:border-dark-700 bg-gray-50/50 dark:bg-dark-800 focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all text-xs font-bold"})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto no-scrollbar space-y-1 pr-1",children:[e.jsxs("button",{onClick:()=>m(""),className:`w-full flex items-center gap-3 p-3 rounded-xl transition-all text-right font-bold text-xs ${i?"text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-dark-800":"bg-primary text-white shadow-lg shadow-primary/20"}`,children:[e.jsx(B,{className:`w-4 h-4 ${i?"text-primary":"text-white"}`}),e.jsx("span",{children:"جميع المشتركين"})]}),f.map(t=>e.jsxs("button",{onClick:()=>m(t.id.toString()),className:`w-full flex items-center gap-3 p-3 rounded-xl transition-all text-right group ${i===t.id.toString()?"bg-primary text-white shadow-lg shadow-primary/20":"text-gray-600 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-dark-800"}`,children:[e.jsx("div",{className:`w-8 h-8 rounded-lg flex items-center justify-center font-black text-[10px] ${i===t.id.toString()?"bg-white/20":"bg-primary/10 text-primary"}`,children:t.name.charAt(0)}),e.jsxs("div",{className:"flex-1 text-right overflow-hidden",children:[e.jsx("div",{className:"text-[11px] font-black truncate",children:t.name}),e.jsx("div",{className:`text-[9px] truncate opacity-60 ${i===t.id.toString()?"text-white":""}`,children:t.email})]})]},t.id))]})]})]})};function le(){const{showSuccess:u,showError:i,showConfirm:m}=$(),[x,c]=A(),[d,N]=o.useState([]),[g,y]=o.useState([]),[_,h]=o.useState(!0),[r,l]=o.useState(null),[n,f]=o.useState(x.get("tenant")||""),C=async()=>{try{const s=(await w.get("/admin/tenants")).data||[];return y(s),s}catch(a){return S.error(a),[]}},t=async()=>{h(!0);try{const a=await w.get("/admin/payments");N(a.data||[])}catch(a){S.error(a),i("فشل تحميل سجل الدفعات")}finally{h(!1)}};o.useEffect(()=>{(async()=>{await C(),await t();const s=x.get("tenant"),p=x.get("highlight");s&&(f(s),p==="true"&&(l(Number(s)),setTimeout(()=>l(null),3e3)))})()},[]);const b=async a=>{if(await m({title:"حذف سجل الدفع",message:"هل أنت متأكد من حذف هذه العملية؟",confirmLabel:"حذف",isDestructive:!0}))try{await w.delete(`/admin/payments/${a}`),u("تم الحذف بنجاح"),t()}catch{i("فشل الحذف")}},j=n?d.filter(a=>{var s;return((s=a.tenant)==null?void 0:s.id)===Number(n)}):d,k=a=>{f(a),c(a?{tenant:a}:{})},v=o.useMemo(()=>[{header:"المستأجر",accessor:a=>{var s,p,L;return e.jsx(V,{name:((s=a.tenant)==null?void 0:s.name)||"---",email:(p=a.tenant)==null?void 0:p.email,highlight:r===((L=a.tenant)==null?void 0:L.id)})},exportValue:a=>{var s;return((s=a.tenant)==null?void 0:s.name)||"---"},className:"min-w-[200px]"},{header:"المبلغ",accessor:a=>e.jsx(q,{amount:a.amount||0,currency:a.currency}),exportValue:a=>`${a.amount||0} ${a.currency}`,className:"min-w-[120px]"},{header:"التاريخ",accessor:a=>e.jsx(z,{date:a.paid_at}),exportValue:a=>R(a.paid_at),width:"15%"},{header:"الطريقة",accessor:a=>e.jsxs("span",{className:"px-3 py-1.5 rounded-xl bg-gray-100 dark:bg-gray-800 text-xs font-black text-gray-600 dark:text-gray-400 border border-gray-200/50 dark:border-white/5",children:[a.payment_method==="cash"&&"نقد",a.payment_method==="bank_transfer"&&"تحويل بنكي",a.payment_method==="check"&&"شيك",a.payment_method==="other"&&a.payment_method]}),exportValue:a=>a.payment_method==="cash"?"نقد":a.payment_method==="bank_transfer"?"تحويل بنكي":a.payment_method==="check"?"شيك":a.payment_method,width:"15%"},{header:"ملاحظات",accessor:a=>e.jsx("span",{className:"text-xs text-gray-400 font-medium truncate block max-w-[200px]",title:a.notes,children:a.notes||"-"}),exportValue:a=>a.notes||"-",width:"20%"},{header:"",accessor:a=>e.jsx(H,{children:e.jsx("button",{onClick:()=>b(a.id),className:"p-2.5 text-red-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl transition-all active:scale-95",children:e.jsx(F,{className:"w-4 h-4"})})}),width:"50px"}],[r,b]);return e.jsx(E,{title:"إدارة المدفوعات",leftSidebarContent:e.jsx(O,{tenants:g,selectedTenantId:n,onSelectTenant:k,onSuccess:t}),children:e.jsx("div",{className:"flex flex-col h-full bg-white dark:bg-gray-900",children:e.jsx("div",{className:"flex-1 overflow-auto",children:e.jsx(M,{columns:v,data:j,isLoading:_,emptyMessage:n?"لا توجد دفعات لهذا المشترك":"لا توجد عمليات دفع مسجلة",exportFileName:"سجل_المدفوعات"})})})})}export{le as default};
