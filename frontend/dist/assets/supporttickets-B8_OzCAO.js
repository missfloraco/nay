import{x as X,r as m,v as G,j as e,s as f,I as H,X as M,w as E,C as J,t as O,f as d}from"./index-CytmB-Er.js";import{u as F}from"./adslot-1WJBBd70.js";import{u as p}from"./useMutation-Cu2w5KoT.js";import{A as V}from"./adminlayout-DIdHhvbo.js";import{a as P}from"./helpers-CPSgdYRA.js";import{M as y}from"./sidebar-left-s-soE1BO.js";import{S as W,A as Y}from"./send-ByfnVC7o.js";import{S as Z}from"./shield-CrI-2Gqb.js";import"./users-DikJyHif.js";import"./loader-circle-Bj7yhw_M.js";import"./log-out-DPAkzXIl.js";import"./user-BVnW-pgT.js";const xe=()=>{var C,_,$,q,K;const i=X(),[t,o]=m.useState(null),[u,v]=m.useState(""),[g,L]=m.useState("all"),{showSuccess:b,showError:c,showConfirm:j}=G(),{data:l,isLoading:A}=F({queryKey:["admin-tickets",g],queryFn:async()=>await d.get(`/admin/support/tickets?status=${g}`),refetchInterval:1e4});m.useEffect(()=>{o(null)},[g]);const{data:a,isLoading:I,error:k}=F({queryKey:["admin-ticket",t],queryFn:async()=>t?await d.get(`/admin/support/tickets/${t}`):null,enabled:!!t,refetchInterval:5e3,retry:1});m.useEffect(()=>{k&&t&&(c("فشل تحميل بيانات التذكرة. قد تكون محذوفة أو غير موجودة."),o(null))},[k,t]);const h=p({mutationFn:r=>d.post(`/admin/support/tickets/${t}/reply`,r),onSuccess:()=>{i.invalidateQueries({queryKey:["admin-ticket",t]}),i.invalidateQueries({queryKey:["admin-tickets"]}),i.invalidateQueries({queryKey:["admin-notifications-count"]}),v("")},onError:()=>c("فشل إرسال الرد")}),D=p({mutationFn:r=>d.patch(`/admin/support/tickets/${t}/status`,r),onSuccess:()=>{i.invalidateQueries({queryKey:["admin-ticket",t]}),i.invalidateQueries({queryKey:["admin-tickets"]}),i.invalidateQueries({queryKey:["admin-notifications-count"]}),b("تم تحديث حالة التذكرة")}}),w=p({mutationFn:()=>d.delete(`/admin/support/tickets/${t}`),onSuccess:()=>{i.invalidateQueries({queryKey:["admin-tickets"]}),i.invalidateQueries({queryKey:["admin-notifications-count"]}),b("تم نقل التذكرة للأرشيف بنجاح"),o(null)},onError:()=>c("فشل أرشفة التذكرة")}),x=p({mutationFn:()=>d.post(`/admin/support/tickets/${t}/restore`),onSuccess:()=>{i.invalidateQueries({queryKey:["admin-ticket",t]}),i.invalidateQueries({queryKey:["admin-tickets"]}),b("تم استعادة التذكرة بنجاح")},onError:()=>c("فشل استعادة التذكرة")}),N=p({mutationFn:()=>d.delete(`/admin/support/tickets/${t}/force`),onSuccess:()=>{i.invalidateQueries({queryKey:["admin-tickets"]}),i.invalidateQueries({queryKey:["admin-notifications-count"]}),b("تم حذف التذكرة نهائياً"),o(null)},onError:()=>c("فشل حذف التذكرة نهائياً")}),z=r=>{r.preventDefault(),u.trim()&&h.mutate({message:u})},B=(r,s=!1)=>{if(s)return"bg-red-100/50 text-red-700 border-red-200";switch(r){case"open":return"bg-blue-100/50 text-blue-700 border-blue-200";case"in_progress":return"bg-yellow-100/50 text-yellow-700 border-yellow-200";case"resolved":return"bg-green-100/50 text-green-700 border-green-200";case"closed":return"bg-gray-100/50 text-gray-700 border-gray-200";default:return"bg-gray-100/50 text-gray-700 border-gray-200"}},S=(r,s=!1)=>s?"مؤرشفة":{all:"الكل",open:"مفتوحة",in_progress:"قيد المعالجة",resolved:"محلولة",closed:"مغلقة",archived:"الأرشيف"}[r]||r,R=r=>({low:"منخفضة",medium:"متوسطة",high:"عالية",urgent:"عاجلة"})[r]||r,U=r=>{const s=P(r,!0),n=s.split("|");return n.length<3?e.jsx("span",{children:s}):e.jsxs("div",{className:"flex flex-col items-end gap-0",children:[e.jsxs("span",{className:"leading-tight",children:[n[0].trim()," | ",n[1].trim()]}),e.jsx("span",{className:"font-black text-[10px] opacity-60 leading-tight",children:n[2].trim()})]})};return e.jsx(V,{title:"إدارة رسائل الدعم",noPadding:!0,leftSidebarContent:e.jsx("div",{className:"flex flex-col h-full bg-white dark:bg-dark-900 overflow-hidden -m-6",children:e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[t?e.jsxs("div",{className:"p-6 bg-gray-50/50 dark:bg-dark-800/50 border-b-2 border-gray-100 dark:border-dark-700 space-y-5 animate-in fade-in duration-500",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("span",{className:"text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 block",children:"إدارة التذكرة"}),e.jsxs("h4",{className:"text-lg font-black text-primary mb-1",children:["# ",t]}),e.jsxs("p",{className:"text-xs font-bold text-gray-800 truncate",children:["مع: ",((C=a==null?void 0:a.tenant)==null?void 0:C.name)||"..."]})]}),e.jsx("button",{onClick:()=>o(null),className:"p-2 bg-white dark:bg-dark-800 border border-gray-100 dark:border-dark-700 hover:bg-gray-100 dark:hover:bg-dark-700 rounded-lg transition-all shadow-sm",children:e.jsx(M,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-[10px] font-black text-gray-400 uppercase tracking-widest mb-3",children:"تحديث الحالة"}),e.jsx("div",{className:"grid grid-cols-1 gap-2",children:["open","in_progress","resolved","closed"].map(r=>e.jsx("button",{onClick:()=>D.mutate({status:r}),disabled:!!(a!=null&&a.deleted_at),className:`px-3 py-2.5 rounded-xl text-[11px] font-bold transition-all border-2 ${(a==null?void 0:a.status)===r?"bg-primary text-white border-primary shadow-lg shadow-primary/10":"bg-white dark:bg-dark-800 text-gray-500 dark:text-gray-400 border-gray-100 dark:border-dark-700 hover:border-gray-300 dark:hover:border-dark-600 hover:bg-gray-50 dark:hover:bg-dark-700"} ${a!=null&&a.deleted_at?"opacity-50 grayscale":""}`,children:S(r)},r))})]}),a!=null&&a.deleted_at?e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("button",{onClick:()=>x.mutate(),disabled:x.isPending,className:"w-full flex items-center justify-center gap-2 py-3.5 bg-green-600 text-white rounded-xl font-black text-[11px] hover:bg-green-700 transition-all shadow-xl shadow-green-100 group active:scale-[0.98]",children:[e.jsx(f,{className:"w-4 h-4 group-hover:rotate-12 transition-transform"}),"استعادة من الأرشيف"]}),e.jsxs("button",{onClick:async()=>{await j({title:"حذف نهائي",message:"هل أنت متأكد من حذف هذه التذكرة نهائياً؟ لا يمكن التراجع عن هذا الإجراء.",isDestructive:!0})&&N.mutate()},disabled:N.isPending,className:"w-full flex items-center justify-center gap-2 py-3.5 bg-red-100 text-red-600 rounded-xl font-black text-[11px] hover:bg-red-200 transition-all border border-red-200 group active:scale-[0.98]",children:[e.jsx(E,{className:"w-4 h-4 group-hover:scale-110 transition-transform"}),"حذف نهائي"]})]}):e.jsxs("button",{onClick:async()=>{await j({title:"أرشفة التذكرة",message:"هل أنت متأكد من نقل هذه التذكرة للأرشيف؟",isDestructive:!0})&&w.mutate()},disabled:w.isPending,className:"w-full flex items-center justify-center gap-2 py-3.5 bg-red-600 text-white rounded-xl font-black text-[11px] hover:bg-red-700 transition-all shadow-xl shadow-red-100 group active:scale-[0.98]",children:[e.jsx(E,{className:"w-4 h-4 group-hover:rotate-12 transition-transform"}),"أرشفة التذكرة"]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3 bg-white dark:bg-dark-800 p-4 rounded-2xl border border-gray-100 dark:border-dark-700 shadow-sm",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-[9px] font-black text-gray-400 dark:text-gray-500 uppercase tracking-widest",children:"الأولوية"}),e.jsx("span",{className:`text-[10px] font-black px-2 py-0.5 rounded-full ${(a==null?void 0:a.priority)==="urgent"?"bg-red-50 dark:bg-red-500/10 text-red-600 dark:text-red-400":"bg-gray-50 dark:bg-dark-700 text-gray-700 dark:text-gray-300"}`,children:R((a==null?void 0:a.priority)||"")})]}),e.jsxs("div",{className:"flex justify-between items-center border-t border-gray-50 dark:border-dark-700 pt-3",children:[e.jsx("span",{className:"text-[9px] font-black text-gray-400 dark:text-gray-500 uppercase tracking-widest",children:"التاريخ"}),e.jsx("span",{className:"text-[10px] font-bold text-gray-600 dark:text-gray-400",children:((_=P(a==null?void 0:a.created_at).split("|")[1])==null?void 0:_.trim())||""})]})]})]})]}):e.jsxs("div",{className:"p-6 border-b border-gray-100 dark:border-dark-800 bg-gray-50/10 dark:bg-dark-800/20",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"p-2.5 bg-gray-900 dark:bg-dark-950 text-white rounded-xl",children:e.jsx(Z,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-black text-gray-900 dark:text-gray-100 tracking-tight",children:"إدارة الدعم"}),e.jsx("p",{className:"text-[10px] font-bold text-gray-400 dark:text-gray-500 uppercase tracking-widest mt-0.5",children:"لوحة التحكم"})]})]}),e.jsx("nav",{className:"space-y-1",children:[{id:"all",label:"الكل",icon:y,color:"text-gray-400"},{id:"open",label:"مفتوحة",icon:J,color:"text-blue-500"},{id:"in_progress",label:"قيد المعالجة",icon:O,color:"text-yellow-500"},{id:"resolved",label:"محلولة",icon:f,color:"text-green-500"},{id:"closed",label:"مغلقة",icon:M,color:"text-gray-500"},{id:"archived",label:"الأرشيف",icon:Y,color:"text-red-400"}].map(r=>{const s=g===r.id;return e.jsxs("button",{onClick:()=>L(r.id),className:`w-full flex items-center gap-3 px-4 py-3 rounded-2xl transition-all font-bold text-xs relative group
                                                ${s?"bg-primary/10 dark:bg-primary/20 text-primary ring-1 ring-primary/20 dark:ring-primary/40 shadow-lg shadow-primary/5":"text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-dark-800/50 hover:text-gray-900 dark:hover:text-white"}`,children:[e.jsx(r.icon,{className:`w-4 h-4 ${s?"text-primary":r.color}`}),e.jsx("span",{className:`flex-1 text-right ${s?"text-primary":""}`,children:r.label}),s&&e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-primary animate-pulse"})]},r.id)})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto no-scrollbar p-5 space-y-4 bg-gray-50/10 dark:bg-dark-900/20",children:A&&!l?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20 text-gray-400 font-bold",children:[e.jsx("div",{className:"animate-spin w-8 h-8 border-4 border-gray-200 border-t-gray-400 rounded-full mb-4"}),e.jsx("span",{className:"text-[9px] uppercase tracking-widest font-black",children:"جاري التحديث..."})]}):(($=l==null?void 0:l.data)==null?void 0:$.length)===0?e.jsxs("div",{className:"text-center py-24 text-gray-300",children:[e.jsx(y,{className:"w-10 h-10 mx-auto mb-6 opacity-20"}),e.jsx("p",{className:"text-[9px] font-black uppercase tracking-[0.2em]",children:"لا توجد تذاكر"})]}):e.jsx("div",{className:"space-y-4",children:(q=l==null?void 0:l.data)==null?void 0:q.map(r=>{var s,n,Q;return e.jsxs("div",{onClick:()=>o(r.id),className:`p-5 rounded-[28px] cursor-pointer transition-all border-2 group relative overflow-hidden ${t===r.id?"bg-white dark:bg-dark-800 border-primary shadow-2xl shadow-primary/5 scale-[1.02]":"bg-white dark:bg-dark-900 border-transparent hover:border-gray-100 dark:hover:border-dark-800 shadow-sm"}`,children:[e.jsx("div",{className:"flex justify-between items-start mb-3",children:e.jsxs("div",{className:"flex flex-col min-w-0",children:[e.jsxs("span",{className:"text-[9px] font-black text-gray-300 uppercase tracking-widest mb-1 group-hover:text-primary transition-colors",children:["#",r.id]}),e.jsx("h4",{className:`font-black text-[13px] line-clamp-1 transition-colors ${t===r.id?"text-primary":"text-gray-900 dark:text-gray-100 group-hover:text-primary"}`,children:r.subject})]})}),e.jsxs("div",{className:"flex justify-between items-center bg-gray-50/50 dark:bg-dark-800/50 p-3 rounded-2xl border border-gray-100/50 dark:border-dark-700/50",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("div",{className:"w-7 h-7 shrink-0 rounded-xl bg-white dark:bg-dark-900 border border-gray-100 dark:border-dark-700 flex items-center justify-center font-black text-[10px] text-primary shadow-sm group-hover:rotate-6 transition-transform",children:(n=(s=r.tenant)==null?void 0:s.name)==null?void 0:n.substring(0,2).toUpperCase()}),e.jsx("span",{className:"text-[10px] font-black text-gray-700 dark:text-gray-300 truncate",children:(Q=r.tenant)==null?void 0:Q.name})]}),e.jsx("div",{className:`px-2 py-0.5 rounded-full text-[8px] font-black uppercase border shrink-0 ${B(r.status,!!r.deleted_at)}`,children:S(r.status,!!r.deleted_at)})]})]},r.id)})})})]})}),children:e.jsx("div",{className:"flex flex-col h-full bg-white dark:bg-dark-900 overflow-hidden relative",children:t?e.jsxs("div",{className:"flex flex-col h-full overflow-hidden",children:[e.jsx("div",{className:"flex-1 overflow-y-auto p-10 space-y-10 bg-gray-50/30 dark:bg-dark-800/30 no-scrollbar",children:I&&!a?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full",children:[e.jsx("div",{className:"animate-spin w-12 h-12 border-4 border-primary border-t-transparent rounded-full mb-4"}),e.jsx("p",{className:"text-xs font-black text-gray-400 uppercase tracking-widest",children:"جاري تحميل المحادثة..."})]}):e.jsx("div",{className:"space-y-10",children:(K=a==null?void 0:a.messages)==null?void 0:K.map(r=>{var s;return e.jsx("div",{className:`flex animate-in fade-in slide-in-from-bottom-2 duration-500 ${r.is_admin_reply?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[75%] rounded-[32px] px-8 py-6 shadow-sm relative transition-all hover:shadow-md ${r.is_admin_reply?"bg-gradient-to-br from-primary to-primary/80 dark:from-primary/90 dark:to-primary/70 text-white rounded-tr-none shadow-xl shadow-primary/30":"bg-white dark:bg-dark-800 text-gray-800 dark:text-gray-100 border-2 border-gray-100 dark:border-dark-700 rounded-tl-none ring-1 ring-dark-950/50 dark:ring-white/5"}`,children:[!r.is_admin_reply&&e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-50 dark:bg-blue-900/20 flex items-center justify-center border border-blue-100 dark:border-blue-900/30",children:e.jsx(y,{className:"w-4 h-4 text-blue-600 dark:text-blue-400"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-[10px] font-black text-gray-400 uppercase tracking-widest",children:"رسالة العميل"}),e.jsx("span",{className:"text-[11px] font-bold text-blue-600 dark:text-blue-400",children:(s=a==null?void 0:a.tenant)==null?void 0:s.name})]})]}),e.jsx("p",{className:"text-[14px] leading-relaxed whitespace-pre-wrap font-bold",children:r.message}),e.jsxs("div",{className:`text-[9px] mt-4 flex items-center justify-end gap-3 font-black uppercase tracking-tighter ${r.is_admin_reply?"text-primary-foreground/70":"text-gray-400 dark:text-gray-500"}`,children:[e.jsx("div",{className:"flex items-center gap-1.5 order-2",children:r.is_admin_reply?e.jsx(f,{className:"w-3.5 h-3.5 text-white/40"}):e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-blue-400"}),"تم الاستلام"]})}),e.jsx("div",{className:"order-1 text-right",children:U(r.created_at)})]})]})},r.id)})})}),a!=null&&a.deleted_at?e.jsxs("div",{className:"p-8 bg-gray-50 border-t flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"p-3 bg-red-50 text-red-600 rounded-2xl",children:e.jsx(H,{className:"w-5 h-5"})}),e.jsx("p",{className:"text-xs font-black text-red-700 uppercase tracking-widest",children:"هذه التذكرة مؤرشفة للقراءة فقط"})]}),e.jsx("button",{onClick:()=>x.mutate(),disabled:x.isPending,className:"px-6 py-3 bg-primary text-white rounded-xl font-black text-[11px] hover:bg-primary/90 transition-all shadow-lg shadow-primary/20",children:x.isPending?"جاري الاستعادة...":"استعادة التذكرة الآن"})]}):e.jsx("div",{className:"p-8 bg-white border-t shrink-0",children:e.jsxs("form",{onSubmit:z,className:"flex gap-4",children:[e.jsxs("div",{className:"flex-1 relative group",children:[e.jsx("input",{type:"text",value:u,onChange:r=>v(r.target.value),placeholder:"اكتب رد النظام هنا...",className:"w-full bg-gray-50 border-2 border-gray-100 rounded-2xl px-6 py-5 text-sm font-bold focus:ring-8 focus:ring-primary/5 focus:border-primary focus:bg-white outline-none transition-all duration-300",disabled:(a==null?void 0:a.status)==="closed"||h.isPending}),e.jsx("div",{className:"absolute inset-y-0 left-5 flex items-center pointer-events-none opacity-20 group-focus-within:opacity-100 transition-opacity",children:e.jsx("div",{className:"w-2 h-2 rounded-full bg-primary animate-pulse"})})]}),e.jsxs("button",{type:"submit",disabled:!u.trim()||h.isPending||(a==null?void 0:a.status)==="closed",className:"w-16 h-16 flex items-center justify-center bg-primary text-white rounded-2xl hover:bg-primary/90 disabled:opacity-30 disabled:grayscale transition-all shadow-2xl shadow-primary/30 group overflow-hidden",children:[e.jsx("div",{className:"relative z-10",children:h.isPending?e.jsx("div",{className:"w-6 h-6 border-2 border-white/30 border-t-white rounded-full animate-spin"}):e.jsx(W,{className:"w-6 h-6 -rotate-90 group-hover:translate-x-1 group-hover:-translate-y-1 transition-transform"})}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-tr from-white/0 via-white/5 to-white/25 opacity-0 group-hover:opacity-100 transition-opacity"})]})]})})]}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center text-gray-400 p-10 text-center bg-gray-50/20 dark:bg-dark-800/20",children:[e.jsxs("div",{className:"relative mb-6",children:[e.jsx(y,{className:"w-24 h-24 opacity-5"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx("div",{className:"w-3 h-3 rounded-full bg-primary/20 animate-ping"})})]}),e.jsx("h3",{className:"text-xl font-bold text-gray-300",children:"اختر تذكرة لبدء المتابعة"}),e.jsx("p",{className:"mt-2 text-sm max-w-sm",children:"سيظهر محتوى المحادثة والردود هنا بمجرد اختيار تذكرة من القائمة الجانبية"})]})})})};export{xe as default};
