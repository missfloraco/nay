import{r as i,u as W,a as z,b as q,c as K,d as V,l as Y,j as e,L as J,C as Q,i as X,e as Z}from"./index-CyxQwsQl.js";import{A as ee,E as te,P as ae}from"./passwordstrengthindicator-CNzLHbf7.js";import{T as se}from"./theme-toggle-DmE4dG8g.js";import{C as re}from"./constants-DPRNOWFl.js";import{o as A,s as l,l as C}from"./schemas-CsUKkzBv.js";import{I as T}from"./input-field-Cci2A17T.js";import{S as oe}from"./select-field-D4KX5DsD.js";import{H as ne,A as ie}from"./house-CDnX24FW.js";import{C as le}from"./circle-check-jDsCbvZI.js";import{M as D}from"./mail-BuZJhIit.js";import{U as ce}from"./user-CAZ9w-Ov.js";import{E as de}from"./eye-COkmuOv-.js";import{G as me}from"./globe-koAPSkYK.js";import{L as pe}from"./sparkles-ClcDe-Ep.js";const ue=A({email:l().email({message:"البريد الإلكتروني غير صالح"}),password:l().min(1,{message:"كلمة المرور مطلوبة"})}),fe=A({fullName:l().min(3,{message:"الاسم الكامل يجب أن يكون 3 أحرف على الأقل"}),email:l().email({message:"البريد الإلكتروني غير صالح"}),password:l().min(6,{message:"كلمة المرور يجب أن تكون 6 أحرف على الأقل"}),country:l().min(2,{message:"الرجاء اختيار الدولة"})}),ge=A({email:l().email({message:"البريد الإلكتروني غير صالح"})});A({name:l().min(2,{message:"الاسم مطلوب"}),email:l().email({message:"بريد إلكتروني غير صحيح"}),whatsapp:l().regex(/^\+?[0-9]{7,15}$/,{message:"رقم الهاتف غير صالح"}).optional().or(C("")),country_code:l().optional(),new_password:l().min(6,{message:"كلمة المرور الجديدة قصيرة جداً"}).optional().or(C("")),confirm_password:l().optional().or(C(""))}).refine(h=>!(h.new_password&&h.new_password!==h.confirm_password),{message:"كلمات المرور غير متطابقة",path:["confirm_password"]});function Oe({initialMode:h="login"}){const[s,L]=i.useState(h),P=W(),m=z(),p=q(),O=K(),[b,u]=i.useState(!1),[v,d]=i.useState(""),[k,x]=i.useState(""),[S,G]=i.useState(!1),{t:o}=V(),[r,j]=i.useState({fullName:"",email:"",password:"",country:"PS"}),[H,N]=i.useState("weak"),[f,U]=i.useState(["","","","","",""]),[g,R]=i.useState(0);i.useEffect(()=>{const t=r.password;t.length===0||t.length<6?N("weak"):t.length<10?N("medium"):N("strong")},[r.password]),i.useEffect(()=>{if(g>0){const t=setTimeout(()=>R(g-1),1e3);return()=>clearTimeout(t)}},[g]),i.useEffect(()=>{const t=f.join("");s==="verification"&&t.length===6&&!b&&_({preventDefault:()=>{}})},[f,s]),i.useEffect(()=>{const a=new URLSearchParams(O.search).get("impersonate_token");a&&(u(!0),m.loginWithToken(a).then(()=>{p("/app")}).catch(n=>{Y.error("Impersonation failed",n),d("رابط الدخول غير صالح أو منتهي الصلاحية"),u(!1)}))},[O.search,m,p]);const F=async()=>{try{await X();const t=await Z.post("/login",{email:r.email,password:r.password});t.type==="admin"?(await P.refreshUser(),p("/admin")):(t.token&&sessionStorage.setItem("tenant_token",t.token),await m.refreshUser(),p("/app"))}catch(t){throw t}},_=async t=>{t.preventDefault(),d(""),x(""),u(!0),console.log("handleSubmit called",{mode:s,formData:r});try{if(s==="login")ue.parse({email:r.email,password:r.password}),await F();else if(s==="register"){fe.parse(r);const a=new FormData;a.append("name",r.fullName),a.append("email",r.email),a.append("password",r.password),a.append("country",r.country),a.append("currency","ILS");const n=await m.register(a);if(n!=null&&n.require_verification){L("verification"),x("تم إرسال رمز التحقق إلى بريدك الإلكتروني");return}p("/app/dashboard")}else if(s==="verification"){const a=f.join("");if(a.length!==6){d("يرجى إدخال رمز التحقق المكون من 6 أرقام");return}await m.completeRegistration(r.email,a),p("/app/dashboard")}else s==="forgot-password"&&(ge.parse({email:r.email}),await m.forgotPassword(r.email),x(o("AUTH.FORGOT_PASSWORD.SUCCESS_MESSAGE")))}catch(a){console.error("Auth error:",a),a.errors?d(a.errors[0].message):a.response&&a.response.data&&a.response.data.message?d(a.response.data.message):d("حدث خطأ غير متوقع. يرجى المحاولة مرة أخرى.")}finally{u(!1)}},E=t=>{L(t),d(""),x("")},$=re.map(t=>({value:t.code,label:t.name}));return e.jsxs(ee,{title:o(`AUTH.${s==="forgot-password"?"FORGOT_PASSWORD":s.toUpperCase()}.TITLE`),subtitle:o(`AUTH.${s==="forgot-password"?"FORGOT_PASSWORD":s.toUpperCase()}.SUBTITLE`),children:[e.jsxs("div",{className:"absolute top-4 right-4 z-50 flex items-center gap-3 flex-row-reverse",children:[e.jsxs(J,{to:"/",className:"flex items-center gap-2 py-2.5 px-5 rounded-2xl bg-gray-50 text-gray-400 hover:text-primary hover:bg-white border border-transparent hover:border-gray-100 transition-all active:scale-95 group shadow-sm hover:shadow-md font-bold text-sm",title:"العودة للرئيسية",children:[e.jsx("span",{className:"hidden sm:inline",children:"الرئيسية"}),e.jsx(ne,{size:18,className:"transition-transform group-hover:translate-x-1"})]}),e.jsx(se,{})]}),e.jsxs("form",{onSubmit:_,className:"space-y-8 animate-in fade-in slide-in-from-bottom-5 duration-500",children:[(v||k)&&e.jsxs("div",{role:"alert",className:`p-4 border rounded-xl text-sm font-bold flex items-center gap-3 animate-in slide-in-from-top-2 duration-300 ${v?"bg-red-50 border-red-100 text-red-600":"bg-emerald-50 border-emerald-100 text-emerald-600"}`,children:[v?e.jsx(Q,{className:"w-5 h-5 shrink-0"}):e.jsx(le,{className:"w-5 h-5 shrink-0"}),e.jsx("span",{children:v||k})]}),e.jsxs("div",{className:"space-y-6",children:[s==="verification"&&e.jsxs("div",{className:"space-y-8 animate-in fade-in zoom-in-95 duration-500",children:[e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("div",{className:"inline-flex items-center justify-center p-3 bg-primary/10 rounded-2xl mb-2 text-primary",children:e.jsx(D,{className:"w-8 h-8"})}),e.jsx("h3",{className:"text-xl font-black text-gray-900 dark:text-white",children:"رمز التحقق"}),e.jsxs("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:["أدخل الرمز المكون من 6 أرقام المرسل إلى ",e.jsx("br",{}),e.jsx("span",{className:"text-gray-900 dark:text-white font-bold",children:r.email})]})]}),e.jsx("div",{className:"flex justify-between gap-2",dir:"ltr",children:f.map((t,a)=>e.jsx("input",{id:`otp-${a}`,type:"text",maxLength:1,value:t,onChange:n=>{var w;const c=n.target.value;if(/^\d*$/.test(c)){const y=[...f];y[a]=c.slice(-1),U(y),c&&a<5&&((w=document.getElementById(`otp-${a+1}`))==null||w.focus())}},onKeyDown:n=>{var c;n.key==="Backspace"&&!t&&a>0&&((c=document.getElementById(`otp-${a-1}`))==null||c.focus())},onPaste:n=>{var w;n.preventDefault();const c=n.clipboardData.getData("text").replace(/\D/g,"").slice(0,6);if(c){const y=[...f];c.split("").forEach((M,I)=>{I<6&&(y[I]=M)}),U(y);const B=Math.min(c.length-1,5);(w=document.getElementById(`otp-${B}`))==null||w.focus()}},className:"w-12 h-16 text-center text-2xl font-black bg-gray-50 dark:bg-dark-900 border-2 border-transparent focus:border-primary focus:bg-white dark:focus:bg-dark-800 rounded-2xl transition-all outline-none",autoFocus:a===0},a))}),e.jsx("div",{className:"text-center",children:e.jsx("button",{type:"button",disabled:g>0||b,onClick:async()=>{var t,a;u(!0);try{await m.resendOTP(r.email),x("تم إرسال كود جديد"),R(60)}catch(n){d(((a=(t=n.response)==null?void 0:t.data)==null?void 0:a.message)||"فشل إرسال الكود")}finally{u(!1)}},className:"text-sm font-bold text-gray-400 hover:text-primary transition-colors disabled:opacity-50",children:g>0?`إعادة الإرسال خلال ${g} ثانية`:"إعادة إرسال الكود؟"})})]}),s!=="verification"&&e.jsxs(e.Fragment,{children:[s==="register"&&e.jsx(T,{label:o("AUTH.REGISTER.FULL_NAME_LABEL"),id:"fullName",type:"text",required:!0,value:r.fullName,onChange:t=>j({...r,fullName:t.target.value}),placeholder:o("AUTH.REGISTER.FULL_NAME_PLACEHOLDER"),icon:ce,autoComplete:"name"}),e.jsx(T,{label:o(`AUTH.${s==="forgot-password"?"FORGOT_PASSWORD":s.toUpperCase()}.EMAIL_LABEL`),id:"email",type:"email",required:!0,value:r.email,onChange:t=>j({...r,email:t.target.value}),placeholder:o(`AUTH.${s==="register"?"REGISTER":"LOGIN"}.EMAIL_PLACEHOLDER`),icon:D,autoComplete:"email"}),s!=="forgot-password"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"relative group",children:e.jsx(T,{label:o(`AUTH.${s.toUpperCase()}.PASSWORD_LABEL`),id:"password",type:S?"text":"password",required:!0,value:r.password,onChange:t=>j({...r,password:t.target.value}),placeholder:o(`AUTH.${s.toUpperCase()}.PASSWORD_PLACEHOLDER`),autoComplete:s==="login"?"current-password":"new-password",className:"!pe-16",endContent:e.jsx("button",{type:"button",onClick:()=>G(!S),className:"text-gray-400 hover:text-primary transition-colors h-5 w-5 flex items-center justify-center p-0",title:S?"إخفاء كلمة المرور":"إظهار كلمة المرور",children:S?e.jsx(te,{size:18}):e.jsx(de,{size:18})})})}),s==="login"&&e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{type:"button",onClick:()=>E("forgot-password"),className:"text-sm font-bold text-gray-500 hover:text-primary transition-colors",children:o("AUTH.LOGIN.FORGOT_PASSWORD")})}),s==="register"&&e.jsx(ae,{strength:H,passwordLength:r.password.length})]}),s==="register"&&e.jsx(oe,{label:o("AUTH.REGISTER.COUNTRY_LABEL"),id:"country",value:r.country,onChange:t=>j({...r,country:t.target.value}),options:$,icon:me})]})]}),e.jsx("button",{type:"submit",disabled:b,className:"w-full h-14 bg-primary text-white rounded-xl font-black text-lg shadow-lg shadow-primary/25 hover:shadow-xl hover:shadow-primary/30 hover:-translate-y-1 active:translate-y-0 transition-all disabled:opacity-50 flex items-center justify-center gap-3 border border-transparent",children:b?e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"w-5 h-5 animate-spin"}),e.jsx("span",{children:"جاري المعالجة..."})]}):s==="verification"?"تأكيد الحساب":o(`AUTH.${s==="forgot-password"?"FORGOT_PASSWORD":s.toUpperCase()}.SUBMIT`)}),e.jsx("div",{className:"pt-8 text-center",children:s==="login"?e.jsxs("p",{className:"text-gray-500 dark:text-gray-400 font-bold",children:[o("AUTH.LOGIN.NO_ACCOUNT")," ",e.jsx("button",{type:"button",onClick:()=>E("register"),className:"text-primary hover:text-primary-dark font-black hover:underline transition-all",children:o("AUTH.LOGIN.REGISTER_NOW")})]}):e.jsxs("button",{type:"button",onClick:()=>E("login"),className:"inline-flex items-center gap-2 text-gray-500 dark:text-gray-400 font-bold hover:text-primary hover:bg-gray-50 dark:hover:bg-white/5 py-2 px-4 rounded-xl transition-all",children:[e.jsx(ie,{className:"w-4 h-4"}),o("AUTH.LOGIN.BACK_TO_LOGIN")]})})]})]})}export{Oe as default};
