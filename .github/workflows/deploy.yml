name: Deploy via SSH (Full App)

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸšš Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install Frontend Dependencies
        working-directory: ./frontend
        run: npm install --legacy-peer-deps

      - name: ğŸš€ Build Frontend (React)
        working-directory: ./frontend
        run: npm run build

      - name: ğŸ“‚ Merge React Build into Laravel Public
        run: |
          cp -r frontend/dist/* backend/public/

      - name: ğŸ—ï¸ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer:v2

      - name: ğŸ“¦ Install Backend Dependencies
        working-directory: ./backend
        run: composer install --no-dev --optimize-autoloader

      - name: ğŸš€ Sync to Hostinger (Manual rsync)
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…ÙØªØ§Ø­ Ù…Ù† Ù…ØªØºÙŠØ± Ø§Ù„Ø¨ÙŠØ¦Ø© Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØªÙ„Ù Ø§Ù„ØªÙ†Ø³ÙŠÙ‚
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙØªØ§Ø­ Ù…Ù† Ø£ÙŠ Ø£Ø­Ø±Ù Ø®ÙÙŠØ© Ù†Ø§ØªØ¬Ø© Ø¹Ù† Ø§Ù„ÙˆÙ†Ø¯ÙˆØ²
          sed -i 's/\r//g' ~/.ssh/id_rsa
          
          # Ø¬Ù„Ø¨ Ø¨ØµÙ…Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±
          ssh-keyscan -p $SSH_PORT -H $SSH_HOST >> ~/.ssh/known_hosts
          
          # ØªÙ†ÙÙŠØ° Ø§Ù„Ø±ÙØ¹ Ø§Ù„ÙØ¹Ù„ÙŠ
          rsync -avz --delete \
            -e "ssh -p $SSH_PORT -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no" \
            backend/ \
            $SSH_USER@$SSH_HOST:public_html/
